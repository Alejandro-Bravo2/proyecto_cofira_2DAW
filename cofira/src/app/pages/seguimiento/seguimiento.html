<main class="seguimiento">

  <h1 class="seguimiento__titulo">CONTADOR DE NUTRIENTES</h1>

  <section class="seguimiento__macronutrientes">
    <article class="seguimiento__card-macros">
      <header class="seguimiento__macros-info">
        <h2 class="seguimiento__macros-titulo">Desglose de Macronutrientes y Calorías</h2>
        <p class="seguimiento__macros-calorias">
          Calorías totales: {{ macrosConsumo().calorias.consumido }}/{{ macrosConsumo().calorias.objetivo }} kcal
        </p>

        <ul class="seguimiento__macros-lista">
          <li class="seguimiento__macro-item">
            <span aria-hidden="true" class="seguimiento__macro-indicador seguimiento__macro-indicador--proteinas"></span>
            <span class="seguimiento__macro-texto">
              Proteínas: {{ macrosConsumo().proteinas.consumido }}g ({{ macrosConsumo().proteinas.porcentajeGrafica }}%)
            </span>
          </li>
          <li class="seguimiento__macro-item">
            <span aria-hidden="true" class="seguimiento__macro-indicador seguimiento__macro-indicador--carbohidratos"></span>
            <span class="seguimiento__macro-texto">
              Carbohidratos: {{ macrosConsumo().carbohidratos.consumido }}g ({{ macrosConsumo().carbohidratos.porcentajeGrafica }}%)
            </span>
          </li>
          <li class="seguimiento__macro-item">
            <span aria-hidden="true" class="seguimiento__macro-indicador seguimiento__macro-indicador--grasas"></span>
            <span class="seguimiento__macro-texto">
              Grasas: {{ macrosConsumo().grasas.consumido }}g ({{ macrosConsumo().grasas.porcentajeGrafica }}%)
            </span>
          </li>
        </ul>

        <dl class="seguimiento__extras">
          <dt class="seguimiento__extra-label">Fibra objetivo:</dt>
          <dd class="seguimiento__extra-valor">{{ fibraObjetivo() }}g</dd>

          <dt class="seguimiento__extra-label">Agua hoy:</dt>
          <dd class="seguimiento__extra-valor">{{ aguaConsumida() | number:'1.1-1' }}L / {{ aguaObjetivo() }}L</dd>
        </dl>
      </header>

      <figure class="seguimiento__grafico-circular">
        @if (macrosConsumo().diasConDatos > 0) {
          <svg aria-label="Gráfico circular de macronutrientes" class="seguimiento__pie-chart" role="img" viewBox="0 0 200 200">
            <circle
              [attr.stroke-dasharray]="calcularDashArray(macrosConsumo().proteinas.porcentajeGrafica)"
              [attr.stroke-dashoffset]="calcularDashOffset(0)"
              cx="100"
              cy="100"
              fill="transparent"
              r="80"
              stroke="#110e10"
              stroke-width="40"
              transform="rotate(-90 100 100)"
            />
            <circle
              [attr.stroke-dasharray]="calcularDashArray(macrosConsumo().carbohidratos.porcentajeGrafica)"
              [attr.stroke-dashoffset]="calcularDashOffset(macrosConsumo().proteinas.porcentajeGrafica)"
              cx="100"
              cy="100"
              fill="transparent"
              r="80"
              stroke="#ffd300"
              stroke-width="40"
              transform="rotate(-90 100 100)"
            />
            <circle
              [attr.stroke-dasharray]="calcularDashArray(macrosConsumo().grasas.porcentajeGrafica)"
              [attr.stroke-dashoffset]="calcularDashOffset(macrosConsumo().proteinas.porcentajeGrafica + macrosConsumo().carbohidratos.porcentajeGrafica)"
              cx="100"
              cy="100"
              fill="transparent"
              r="80"
              stroke="#3f454c"
              stroke-width="40"
              transform="rotate(-90 100 100)"
            />
          </svg>
        } @else {
          <aside class="seguimiento__sin-datos-circular">
            <p>Sin datos de alimentación</p>
            <p class="seguimiento__ayuda">Genera tu menú semanal para ver tus macros</p>
          </aside>
        }
      </figure>
    </article>
  </section>

  <section class="seguimiento__fuerza">
    <h2 class="seguimiento__fuerza-titulo">Ganancia de fuerza</h2>

    <nav class="seguimiento__selector-ejercicio">
      @if (ejerciciosDisponibles().length > 0) {
        <select
          [ngModel]="ejercicioSeleccionado()"
          (ngModelChange)="ejercicioSeleccionado.set($event); cambiarEjercicio()"
          class="seguimiento__select">
          @for (ejercicio of ejerciciosDisponibles(); track ejercicio) {
            <option [value]="ejercicio">{{ ejercicio }}</option>
          }
        </select>
      } @else {
        <p class="seguimiento__sin-datos">No hay ejercicios registrados</p>
      }
    </nav>

    <article class="seguimiento__grafico-lineas">
      @if (cargandoGrafico()) {
        <div class="seguimiento__cargando">
          <p>Cargando datos...</p>
        </div>
      } @else if (puntosGrafico().length === 0) {
        <div class="seguimiento__sin-datos-grafico">
          <p class="seguimiento__sin-datos-grafico__mensaje">No hay datos de peso registrados para este ejercicio.</p>
          <p class="seguimiento__ayuda">Registra el peso levantado en tus entrenamientos para ver tu progreso aquí.</p>
        </div>
      } @else {
        <figure class="seguimiento__chart-container">
          <svg aria-label="Gráfico de evolución de fuerza" class="seguimiento__line-chart" role="img" viewBox="-30 0 630 300">
            <!-- Ejes -->
            <line stroke="#b8b8b8" stroke-width="1" x1="50" x2="50" y1="20" y2="250"/>
            <line stroke="#b8b8b8" stroke-width="1" x1="50" x2="580" y1="250" y2="250"/>

            <!-- Etiquetas eje Y dinámicas -->
            <text class="seguimiento__chart-label" text-anchor="end" x="40" y="35">{{ pesoMaximoGrafico() }}kg</text>
            <text class="seguimiento__chart-label" text-anchor="end" x="40" y="90">{{ pesoMaximoGrafico() * 0.75 | number:'1.0-0' }}kg</text>
            <text class="seguimiento__chart-label" text-anchor="end" x="40" y="145">{{ pesoMaximoGrafico() * 0.5 | number:'1.0-0' }}kg</text>
            <text class="seguimiento__chart-label" text-anchor="end" x="40" y="200">{{ pesoMaximoGrafico() * 0.25 | number:'1.0-0' }}kg</text>
            <text class="seguimiento__chart-label" text-anchor="end" x="40" y="255">0kg</text>

            <!-- Líneas guía horizontales -->
            <line stroke="#e0e0e0" stroke-dasharray="5,5" stroke-width="1" x1="50" x2="580" y1="35" y2="35"/>
            <line stroke="#e0e0e0" stroke-dasharray="5,5" stroke-width="1" x1="50" x2="580" y1="90" y2="90"/>
            <line stroke="#e0e0e0" stroke-dasharray="5,5" stroke-width="1" x1="50" x2="580" y1="145" y2="145"/>
            <line stroke="#e0e0e0" stroke-dasharray="5,5" stroke-width="1" x1="50" x2="580" y1="200" y2="200"/>

            <!-- Etiquetas eje X dinámicas -->
            @for (punto of fechasEjeX(); track punto.fecha) {
              <text class="seguimiento__chart-label" text-anchor="middle" [attr.x]="punto.x" y="270">{{ punto.fecha }}</text>
            }

            <!-- Etiquetas de ejes -->
            <text class="seguimiento__chart-label-axis" text-anchor="middle" x="315" y="295">Fecha</text>
            <text class="seguimiento__chart-label-axis" text-anchor="middle" transform="rotate(-90 -10 145)" x="-10" y="145">Peso levantado (kg)</text>

            <!-- Línea del gráfico -->
            @if (polylinePoints()) {
              <polyline
                fill="none"
                [attr.points]="polylinePoints()"
                stroke="#ffd300"
                stroke-width="2"
              />
            }

            <!-- Puntos del gráfico -->
            @for (punto of puntosGrafico(); track punto.fecha; let ultimo = $last) {
              <circle [attr.cx]="punto.x" [attr.cy]="punto.y" fill="#ffd300" r="5">
                @if (ultimo) {
                  <animate attributeName="r" dur="1s" repeatCount="indefinite" values="5;7;5"/>
                }
              </circle>
              <title>{{ punto.fecha }}: {{ punto.peso }}kg</title>
            }
          </svg>
        </figure>
      }
    </article>
  </section>

</main>
